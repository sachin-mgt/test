<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputArgument; use Symfony\Component\Console\Input\InputOption; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Input\InputDefinition; use Symfony\Component\Console\Output\OutputInterface; class FillQueueCommand extends Command { const INPUT_STORE_ID = "\163\164\x6f\162\145\55\x69\144"; const ENTITY_TYPE_CATEGORY = "\x63\141\164\x65\x67\157\x72\x79"; const ENTITY_TYPE_PRODUCT = "\160\162\157\x64\x75\143\x74"; const URL_QUEUE_BATCH_SIZE = 2500; protected $logger; protected $storeManager; protected $categoryCollection; protected $urlQueueResource; protected $urlQueue; protected $numberOfUrls = 0; protected $categories = []; protected $state; public function __construct() { goto bc72c; Cf7a8: $this->urlQueue = $objectManager->get("\x5c\115\147\164\x5c\126\141\x72\x6e\x69\x73\150\134\x4d\x6f\144\145\x6c\x5c\x55\162\154\x51\165\x65\x75\145"); goto a3ac1; dd13b: $this->categoryCollection = $objectManager->get("\134\x4d\x61\147\x65\156\x74\157\x5c\103\x61\x74\141\154\x6f\147\134\115\x6f\x64\x65\154\134\x52\145\163\x6f\x75\162\x63\x65\115\x6f\144\x65\154\134\x43\x61\x74\x65\147\157\x72\171\x5c\x43\x6f\x6c\x6c\x65\143\164\x69\x6f\x6e"); goto e0dfd; dfb70: $this->logger = $objectManager->get("\x5c\x50\163\x72\134\x4c\x6f\147\134\114\157\147\x67\145\x72\x49\x6e\164\145\x72\x66\x61\x63\145"); goto B7d11; e0dfd: $this->urlQueueResource = $objectManager->get("\134\x4d\x67\x74\x5c\x56\141\162\x6e\x69\x73\150\x5c\x4d\157\x64\145\154\134\x52\x65\163\x6f\165\x72\x63\145\x4d\x6f\144\x65\x6c\x5c\x55\x72\154\121\x75\x65\165\145"); goto Cf7a8; B7d11: $this->storeManager = $objectManager->get("\134\115\141\x67\x65\156\x74\x6f\134\123\164\157\x72\x65\x5c\115\157\144\x65\154\x5c\123\164\157\x72\x65\x4d\x61\156\141\147\145\x72\x49\156\x74\x65\x72\x66\141\x63\x65"); goto dd13b; bc72c: $objectManager = $this->getObjectManager(); goto dfb70; a3ac1: parent::__construct(); goto c3caf; c3caf: } protected function configure() { goto d1e97; C41e2: $this->setDescription("\115\107\x54\x20\126\x61\162\156\x69\x73\150\x20\103\141\x63\x68\145\x20\121\x75\145\165\145\x20\106\151\x6c\154\145\162"); goto Fd6f2; Fd6f2: $this->setDefinition(new InputDefinition(array(new InputOption(self::INPUT_STORE_ID, null, InputOption::VALUE_OPTIONAL, '')))); goto C97a2; d1e97: $this->setName("\155\147\x74\x2d\x76\x61\162\x6e\x69\163\150\72\x66\151\x6c\154\x2d\161\x75\145\165\x65"); goto C41e2; C97a2: parent::configure(); goto f3f68; f3f68: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto Feac7; ce596: A97ec: goto e645a; acd3d: $store = null; goto bbd4d; F493f: if (!$storeId) { goto A97ec; } goto a9442; C03c8: $output->writeln(sprintf("\x3c\x69\156\146\x6f\76\45\x73\40\x55\122\114\x73\x20\x61\144\x64\145\144\40\164\157\40\x56\x61\x72\156\151\x73\x68\x20\x51\165\145\x75\145\x3c\x2f\151\x6e\x66\x6f\x3e", $this->numberOfUrls)); goto C175a; e645a: $this->addCategoryUrls($store); goto dc62c; dc62c: $this->addProductUrls($store); goto A0e09; C175a: bfa34: goto A2af0; bbd4d: $storeId = (int) $input->getOption(self::INPUT_STORE_ID); goto F493f; Feac7: ini_set("\155\145\155\x6f\162\x79\137\x6c\x69\x6d\151\164", "\x32\x30\x34\70\115"); goto acd3d; A0e09: if (!($this->numberOfUrls > 0)) { goto bfa34; } goto C03c8; a9442: try { $store = $this->storeManager->getStore($storeId); $this->storeManager->setCurrentStore($store); } catch (\Exception $e) { goto B522c; B522c: $output->writeln(sprintf("\74\x65\162\x72\x6f\162\76\123\x74\x6f\162\x65\40\167\x69\164\x68\x20\x49\x44\40\x22\45\x73\42\40\144\157\x65\x73\x20\x6e\x6f\x74\40\145\170\151\x73\164\x73\74\57\x65\162\162\x6f\162\76", $storeId)); goto ac32a; d4f0c: $output->writeln(sprintf("\x3c\x63\157\x6d\x6d\x65\156\164\x3e\x41\x76\x61\x69\x6c\x61\142\154\x65\x20\x53\164\x6f\162\x65\x73\x3c\x2f\143\157\155\155\145\x6e\x74\76")); goto B4dd6; ac32a: $output->writeln(''); goto d4f0c; B4dd6: return $this->showStores($output); goto Dea5a; Dea5a: } goto ce596; A2af0: } catch (\Exception $e) { goto Ded36; Ba172: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto Dd266; Ded36: $errorMessage = $e->getMessage(); goto Cf0d7; Cf0d7: $output->writeln(sprintf("\74\145\162\x72\157\x72\76\x25\x73\74\57\145\162\162\x6f\x72\x3e", $errorMessage)); goto Ba172; Dd266: } } protected function addCategoryUrls(\Magento\Store\Model\Store $store = null) { goto f15db; De471: if (!count($urls)) { goto cda5c; } goto C3096; db4c2: dc2da: goto bae4f; d83a9: $this->urlQueue->addToQueue($urls); goto E9441; bae4f: if (!count($this->categories)) { goto D0cc3; } goto a9a37; ac6b1: $this->categoryCollection->addAttributeToSelect("\145\156\x74\151\164\x79\137\151\144"); goto F93b6; E666e: $urls = []; goto C4743; F93b6: foreach ($this->categoryCollection as $category) { $this->categories[$category->getId()] = $category; e448c: } goto db4c2; D27c5: $urlRewriteCollection->addStoreFilter($storeId, false); goto E929d; a9a37: $categoryIds = array_keys($this->categories); goto e2b35; ab85f: $urlRewriteCollection = $objectManager->create("\134\x4d\x67\x74\134\126\141\x72\x6e\151\x73\150\x5c\x4d\x6f\x64\145\154\x5c\x52\145\163\157\165\162\143\145\115\x6f\x64\x65\154\134\x55\x72\154\122\x65\167\162\x69\x74\x65\x5c\x55\162\x6c\x52\x65\167\x72\x69\x74\145\103\157\x6c\x6c\145\143\x74\151\x6f\156"); goto D607a; f15db: $objectManager = $this->getObjectManager(); goto ab85f; C4743: foreach ($urlRewriteCollection as $urlRewrite) { goto b2c4d; f17f5: b2fbd: goto a1f01; e7694: if (isset($urlRewrites[$urlRewriteId])) { goto b132b; } goto f40fe; E33cf: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto F786c; F786c: b132b: goto f17f5; b2c4d: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto e7694; f40fe: $urls[] = ["\x73\164\x6f\x72\x65\x5f\151\x64" => $urlRewrite->getStoreId(), "\160\x61\164\x68" => $urlRewrite->getRequestPath(), "\x70\162\x69\157\162\x69\x74\x79" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_MEDIUM]; goto E33cf; a1f01: } goto B2a83; C3096: $this->numberOfUrls += count($urls); goto d83a9; De679: D0cc3: goto E4c13; D607a: if (!(null !== $store)) { goto D6eb4; } goto c6d3e; B2a83: c3919: goto De471; E929d: D6eb4: goto ac6b1; E9441: cda5c: goto De679; E57fd: $this->categoryCollection->setStore($store); goto D27c5; b39ce: $urlRewriteCollection->addEntityIdFilter($categoryIds); goto af387; e2b35: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_CATEGORY); goto b39ce; af387: $urlRewrites = []; goto E666e; c6d3e: $storeId = $store->getStoreId(); goto E57fd; E4c13: } protected function addProductUrls(\Magento\Store\Model\Store $store = null) { goto f6a35; Bdcbf: Ac6b8: goto A56f8; F54db: $configurableProduct = $objectManager->get("\134\x4d\x61\147\x65\156\164\157\x5c\x43\x6f\156\146\151\147\x75\162\141\142\x6c\x65\x50\162\x6f\144\165\143\164\134\x4d\x6f\x64\145\x6c\x5c\x52\x65\163\x6f\165\162\x63\145\x4d\x6f\x64\x65\x6c\134\120\x72\157\144\165\143\x74\134\124\171\x70\x65\x5c\103\x6f\156\146\151\147\x75\162\141\142\154\x65"); goto f6313; B2f14: $productVisibility = $objectManager->get("\x5c\x4d\x61\x67\145\156\x74\157\134\103\x61\164\x61\x6c\157\147\134\x4d\x6f\x64\145\x6c\134\120\x72\157\144\165\143\x74\x5c\x56\x69\x73\151\x62\151\x6c\151\164\171"); goto C3268; fd03f: $objectManager = $this->getObjectManager(); goto F54db; C3268: $productIds = []; goto E0692; f6313: $productStatus = $objectManager->get("\x5c\115\x61\x67\145\156\164\157\134\x43\141\164\x61\x6c\x6f\x67\x5c\115\157\144\x65\154\134\x50\x72\157\x64\165\143\x74\134\101\x74\x74\162\151\x62\x75\164\x65\x5c\123\157\x75\x72\x63\x65\x5c\x53\x74\x61\164\x75\x73"); goto B2f14; f6a35: if (!count($this->categories)) { goto Ac6b8; } goto fd03f; fde16: Ee4e6: goto Bdcbf; E0692: foreach ($this->categories as $category) { goto F6c63; dc5ef: foreach ($urlRewriteCollection as $urlRewrite) { goto d4368; D9213: fc69c: goto B92ae; d4368: $urlRewriteId = $urlRewrite->getUrlRewriteId(); goto Dee50; Dee50: if (isset($urlRewrites[$urlRewriteId])) { goto aab59; } goto c4e46; c4e46: $urls[] = ["\163\164\157\162\145\x5f\x69\144" => $urlRewrite->getStoreId(), "\x70\141\164\x68" => $urlRewrite->getRequestPath(), "\x70\x72\x69\157\162\151\164\171" => \Mgt\Varnish\Model\UrlQueue::PRIORITY_LOW]; goto cb4f9; d32b4: aab59: goto D9213; cb4f9: $urlRewrites[$urlRewriteId] = $urlRewriteId; goto d32b4; B92ae: } goto C0239; be161: d98d4: goto c740d; f7388: $break = false; goto C03ab; d13dd: $productCollection->addAttributeToSelect(["\145\156\x74\x69\x74\x79\137\x69\144", "\x73\164\x61\164\165\x73"]); goto Fdd98; d5455: if (false === empty($entityIds)) { goto f8d39; } goto b3fb5; C03ab: $i = 0; goto A15ea; d20ad: A72d8: goto E74e5; f235b: f5444: goto F54bb; C9e75: $urlRewriteCollection = $objectManager->create("\x5c\x4d\147\164\134\126\x61\x72\156\151\x73\150\x5c\x4d\157\144\145\x6c\x5c\x52\x65\x73\157\165\162\143\145\x4d\x6f\144\x65\154\x5c\x55\162\154\122\x65\x77\x72\151\164\145\x5c\125\x72\x6c\x52\145\x77\162\151\164\x65\x43\157\154\154\x65\x63\x74\x69\157\156"); goto A2200; Da93f: $this->urlQueue->addToQueue($urls); goto a09e9; Cf3d5: $entityIds = []; goto E1be4; E74e5: $productCollection->setCurPage(++$i); goto B8149; E1be4: foreach ($productCollection as $product) { goto e12ae; cdb16: b22bd: goto C2592; feb30: C5983: goto E5381; D3027: d3dbd: goto cdb16; E7ab0: if ("\x63\x6f\156\146\x69\x67\165\x72\x61\x62\x6c\145" == $product->getTypeId()) { goto C5983; } goto B15df; aa02f: fdb3e: goto A6b92; B15df: $parentIds = $configurableProduct->getParentIdsByChild($productId); goto Ebf5c; e4fb9: Bfca7: goto D3027; ef7fb: if (isset($productIds[$productId])) { goto d3dbd; } goto E7ab0; Db2a0: $entityIds[$productId] = $productId; goto e4fb9; A6b92: goto Bfca7; goto feb30; Ebf5c: if (!(true === empty($parentIds))) { goto fdb3e; } goto E2e9b; aa95a: $entityIds[$productId] = $productId; goto aa02f; E2e9b: $productIds[$productId] = $productId; goto aa95a; e12ae: $productId = $product->getId(); goto ef7fb; E5381: $productIds[$productId] = $productId; goto Db2a0; C2592: } goto C9d61; B8149: $productCollection->setPageSize(self::URL_QUEUE_BATCH_SIZE); goto Cf3d5; b3fb5: $break = true; goto Cff64; F54bb: $urlRewriteCollection->addEntityTypeFilter(self::ENTITY_TYPE_PRODUCT); goto c0d08; Bcded: $urls = []; goto dc5ef; Fdd98: $productCollection->addAttributeToFilter("\x73\x74\141\x74\165\163", ["\151\x6e" => $productStatus->getVisibleStatusIds()]); goto E6025; A8537: $urlRewriteCollection->addStoreFilter($storeId, false); goto f235b; cb520: $productCollection->clear(); goto Aa481; F981a: $storeId = $store->getStoreId(); goto A8537; c0d08: $urlRewriteCollection->addEntityIdFilter($entityIds); goto af1f2; C9d61: cccf9: goto d5455; Cff64: goto C6d6d; goto E444e; E6025: $productCollection->setVisibility($productVisibility->getVisibleInSiteIds()); goto cb4d3; E444e: f8d39: goto C9e75; F6c63: $productCollection = $objectManager->create("\x5c\x4d\141\147\x65\156\x74\x6f\x5c\103\141\x74\x61\x6c\157\147\x5c\115\157\144\x65\154\134\x52\145\x73\x6f\x75\x72\143\x65\x4d\157\144\145\154\x5c\120\x72\x6f\144\165\143\164\x5c\x43\157\x6c\x6c\x65\x63\x74\x69\x6f\156"); goto d13dd; cb4d3: $productCollection->addCategoryFilter($category); goto f7388; A2200: if (!(null !== $store)) { goto f5444; } goto F981a; Dd4c3: if (!count($urls)) { goto e6a20; } goto Ec5a9; C0239: A484d: goto Dd4c3; c96ab: C6d6d: goto ebb7d; A15ea: dfcd8: goto cb520; af1f2: $urlRewrites = []; goto Bcded; c740d: fc6b5: goto F42e3; a09e9: e6a20: goto c96ab; Aeaaf: $productCollection->addStoreFilter($store); goto d20ad; ebb7d: if ($break == false) { goto dfcd8; } goto be161; Ec5a9: $this->numberOfUrls += count($urls); goto Da93f; Aa481: if (!(null !== $store)) { goto A72d8; } goto Aeaaf; F42e3: } goto fde16; A56f8: } protected function getObjectManager() { $objectManager = \Magento\Framework\App\ObjectManager::getInstance(); return $objectManager; } protected function showStores(OutputInterface $output) { goto D1b36; D1b36: $table = $this->getHelperSet()->get("\164\141\x62\154\145"); goto E8582; E8582: $table->setHeaders(["\123\164\157\162\145\x20\x49\104", "\x42\x61\163\x65\40\x55\x52\114"]); goto bc829; Ffcf7: foreach ($stores as $store) { goto Ff269; Ff269: $row = [$store->getStoreId(), $store->getBaseUrl()]; goto cc849; cc849: $table->addRow($row); goto e8841; e8841: F7add: goto b9bcc; b9bcc: } goto Ac3b3; d43e6: $table->render($output); goto D56de; Ac3b3: B8b6e: goto d43e6; bc829: $stores = $this->storeManager->getStores(); goto Ffcf7; D56de: } }
