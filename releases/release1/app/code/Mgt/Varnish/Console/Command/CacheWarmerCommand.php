<?php
 namespace Mgt\Varnish\Console\Command; use Symfony\Component\Console\Command\Command; use Symfony\Component\Console\Input\InputInterface; use Symfony\Component\Console\Output\OutputInterface; use Symfony\Component\Filesystem\Filesystem; use Symfony\Component\Process\Process; class CacheWarmerCommand extends Command { const USER_AGENT = "\x4d\x67\x74\x56\141\x72\156\x69\x73\x68\103\162\141\x77\154\x65\x72"; const CACHE_WARMER_CACHE_KEY = "\x4d\147\164\x43\141\143\x68\x65\x57\141\x72\x6d\x65\162"; const CACHE_WARMER_CRAWLED_URLS = "\115\x67\x74\x43\141\x63\150\145\127\x61\x72\155\x65\162\x43\162\x61\167\154\145\144\125\x72\x6c\x73"; protected $curlAdapter; protected $logger; protected $directoryList; protected $storeManager; protected $cache; protected $cachePurger; protected $lockFile; protected $isLocked; protected $varnishConfig; protected $urlResource; protected $urlQueueResource; protected $urlQueueCollection; public function __construct(\Magento\Framework\HTTP\Adapter\Curl $curlAdapter, \Psr\Log\LoggerInterface $logger, \Magento\Framework\App\Filesystem\DirectoryList $directoryList, \Magento\Store\Model\StoreManagerInterface $storeManager, \Mgt\Varnish\Model\Cache\Backend\File $cache, \Magento\CacheInvalidate\Model\PurgeCache $cachePurger, \Mgt\Varnish\Model\Cache\Config $varnishConfig, \Mgt\Varnish\Model\ResourceModel\Url $urlResource, \Mgt\Varnish\Model\ResourceModel\UrlQueue $urlQueueResource, \Mgt\Varnish\Model\ResourceModel\UrlQueue\Collection $urlQueueCollection) { goto b4723; A35be: $this->varnishConfig = $varnishConfig; goto B04e0; ff182: $this->logger = $logger; goto Bc151; Bc151: $this->directoryList = $directoryList; goto Cf801; dde96: parent::__construct(); goto dcfc0; Eac4a: $this->cache = $cache; goto c2268; aaf43: $this->urlQueueResource = $urlQueueResource; goto e976e; B04e0: $this->urlResource = $urlResource; goto aaf43; b4723: $this->curlAdapter = $curlAdapter; goto ff182; Cf801: $this->storeManager = $storeManager; goto Eac4a; e976e: $this->urlQueueCollection = $urlQueueCollection; goto dde96; c2268: $this->cachePurger = $cachePurger; goto A35be; dcfc0: } protected function configure() { goto b16ac; ab0d9: $this->setDescription("\115\x47\124\40\126\141\162\156\x69\x73\150\x20\x43\141\x63\x68\x65\40\x57\141\162\x6d\x65\162"); goto caa2b; caa2b: parent::configure(); goto Cf569; b16ac: $this->setName("\x6d\147\164\55\166\141\162\156\151\x73\x68\72\143\141\x63\150\145\55\x77\141\162\x6d\x65\162"); goto ab0d9; Cf569: } protected function execute(InputInterface $input, OutputInterface $output) { try { goto Ba82f; B3021: $totalCpuUtilization = $loadAverage[0] * 100 / $numberOfProcessingUnits; goto d7c5c; cc13c: $this->urlQueueCollection->setPageSize($numberOfThreads); goto afd87; F239a: if (!($totalCpuUtilization > $cacheWarmerCpuLimit)) { goto a9594; } goto De007; C909a: $i = 0; goto e1f0d; Aa23d: $i = $i + $numberOfThreads; goto c678d; d3d6a: $this->deleteFromQueue($urls); goto Bc6ae; Bc6ae: Afd68: goto D9142; E5630: Fefbb: goto d2919; d2919: if ($break == false) { goto e11d1; } goto E9b9b; d7c5c: $totalCpuUtilization = min($totalCpuUtilization, 100); goto da423; Ec81a: if (false === $this->isLocked()) { goto A0910; } goto d15e9; ff979: if (!($i == 1000)) { goto Fefbb; } goto E79a6; c678d: $this->urlQueueCollection->clear(); goto cc13c; f470c: if (!(true === $isCacheWarmerCpuLimitEnabled)) { goto A129c; } goto Dfa20; Fc07e: if (!(false === $break)) { goto bf126; } goto C201e; e1f0d: e11d1: goto f48db; Af910: $output->writeln(sprintf("\103\x75\162\162\145\x6e\164\154\x79\40\x74\x68\145\40\103\120\125\40\x6c\x69\155\151\164\40\x68\x61\163\x20\x62\x65\145\156\40\x72\x65\141\x63\150\145\144\x2c\x20\x43\120\x55\x3a\x20\42\x25\x73\x20\x70\x65\162\143\145\x6e\x74\42\x2c\40\x4c\x69\x6d\151\164\x3a\40\x22\45\163\40\x70\x65\x72\x63\145\x6e\x74\42", round($totalCpuUtilization), round($cacheWarmerCpuLimit))); goto ffde2; Dfa20: $numberOfProcessingUnits = $this->runCommand("\x6e\160\x72\157\x63"); goto e7f5c; B2268: af3de: goto F7408; f48db: $this->updateTimestamp(); goto db105; F3c98: $this->deleteExpiredUrls(); goto ecfc3; De007: $break = true; goto Af910; F34e4: goto Ec733; goto db9f1; cac16: $urls = []; goto Eff80; Bfb6c: $this->urlQueueCollection->load(); goto D107b; da423: $cacheWarmerCpuLimit = $this->varnishConfig->getCacheWarmerCpuLimit(); goto F239a; C201e: $numberOfThreads = $this->varnishConfig->getNumberOfCacheWarmerThreads(); goto Aa23d; C8a3f: goto Afd68; goto a4c70; d15e9: $output->writeln("\103\x61\143\150\145\40\127\x61\162\x6d\x65\162\x20\151\x73\x20\x61\x6c\x72\x65\x61\144\x79\x20\x72\x75\x6e\156\151\156\147"); goto F34e4; F7408: $this->crawlUrls($urls, $output); goto d3d6a; a4c70: C31f6: goto cac16; D9142: bf126: goto ff979; f7a85: A129c: goto Fc07e; afd87: $this->urlQueueCollection->addOrder("\160\162\x69\157\162\x69\x74\x79"); goto Bfb6c; e7f5c: $loadAverage = sys_getloadavg(); goto B3021; b3184: Ec733: goto ed612; F2654: $this->lock(); goto F3c98; Ba82f: ini_set("\x6d\145\155\x6f\x72\x79\x5f\154\151\155\x69\x74", "\62\x30\64\x38\115"); goto Ec81a; ffde2: a9594: goto f7a85; ecfc3: $break = false; goto C909a; db105: $isCacheWarmerCpuLimitEnabled = $this->varnishConfig->isCacheWarmerCpuLimitEnabled(); goto f470c; daf31: $break = true; goto C8a3f; db9f1: A0910: goto F2654; E79a6: $break = true; goto E5630; Eff80: foreach ($this->urlQueueCollection as $urlQueue) { try { goto a4622; a4622: $storeId = $urlQueue->getStoreId(); goto f25c2; f25c2: $store = $this->storeManager->getStore($storeId); goto Dde38; E396d: $urls[$urlQueue->getId()] = $url; goto d6fd1; Dde38: $url = sprintf("\x25\x73\57\45\x73", rtrim($store->getBaseUrl(), "\x2f"), ltrim($urlQueue->getPath(), "\57")); goto E396d; d6fd1: } catch (\Exception $e) { } ffd93: } goto B2268; E9b9b: Fdf0e: goto b3184; D107b: if (count($this->urlQueueCollection)) { goto C31f6; } goto daf31; ed612: } catch (\Exception $e) { goto de2ae; F21d5: $output->writeln(sprintf("\x3c\x65\162\x72\157\162\76\45\x73\74\x2f\145\x72\x72\157\x72\76", $errorMessage)); goto d43e7; de2ae: $errorMessage = $e->getMessage(); goto F21d5; d43e7: return \Magento\Framework\Console\Cli::RETURN_FAILURE; goto Ecd60; Ecd60: } } protected function updateTimestamp() { goto A5def; cb80a: $this->cache->save($now, self::CACHE_WARMER_CACHE_KEY); goto E49e1; E5fa5: $now = $now->getTimestamp(); goto cb80a; A5def: $now = new \DateTime("\x6e\x6f\167", new \DateTimeZone("\125\124\x43")); goto E5fa5; E49e1: } public function crawlUrls(array $urls, OutputInterface $output) { try { goto b911a; f20fd: afa59: goto e86f1; b2741: $this->curlAdapter->multiRequest($urls, $options); goto c9307; b911a: $options = array(CURLOPT_USERAGENT => self::USER_AGENT, CURLOPT_SSL_VERIFYPEER => 0); goto b2741; c9307: foreach ($urls as $url) { $output->writeln(sprintf("\x3c\151\156\x66\157\76\x22\45\163\42\x20\x63\162\141\x77\x6c\145\x64\74\57\151\x6e\146\x6f\76", $url)); Ed7ce: } goto f20fd; e86f1: } catch (\Exception $e) { $errorMessage = sprintf("\x41\x6e\x20\x65\162\x72\x6f\162\40\157\143\143\165\162\x72\145\x64\40\144\165\162\x69\156\x67\x20\x63\162\x61\167\x6c\151\x6e\x67\40\x75\x72\x6c\163\54\40\145\x72\x72\157\x72\x20\155\x65\163\x73\x61\x67\145\x3a\x20\45\163", $e->getMessage()); $this->logger->error($errorMessage); } } protected function deleteExpiredUrls() { try { $this->urlResource->deleteExpiredUrls(); } catch (\Exception $e) { $errorMessage = sprintf("\101\156\x20\145\x72\162\x6f\162\x20\x6f\x63\143\165\162\x72\x65\x64\x20\144\x75\x72\x69\156\147\x20\144\x65\x6c\x65\164\x69\156\x67\40\x65\170\x70\x69\162\x65\x64\40\165\162\x6c\x73\x2c\40\x65\162\x72\157\162\x20\x6d\145\163\x73\x61\x67\145\x3a\40\x25\163", $e->getMessage()); $this->logger->error($errorMessage); } } public function deleteFromQueue(array $urls) { try { $urlIds = array_keys($urls); $this->urlQueueResource->deleteFromQueue($urlIds); } catch (\Exception $e) { $errorMessage = sprintf("\101\156\x20\145\x72\x72\x6f\x72\x20\157\143\143\x75\162\162\x65\x64\x20\x64\165\162\151\x6e\147\x20\144\x65\x6c\145\x74\x69\156\x67\x20\x75\162\x6c\163\x2c\x20\145\162\x72\x6f\162\40\x6d\x65\163\163\x61\x67\x65\x3a\x20\45\163", $e->getMessage()); $this->logger->error($errorMessage); } } protected function getLockFile() { goto bbd12; cf118: fwrite($this->lockFile, date("\162")); goto cae56; Bae03: return $this->lockFile; goto Caaac; a40ab: $this->lockFile = fopen($lockFile, "\x77"); goto d7060; bde7a: $this->lockFile = fopen($lockFile, "\170"); goto B6387; Eed2c: $lockFileDirectory = $this->directoryList->getPath("\x74\155\x70"); goto Ed20e; D3cfc: $filesystem = new Filesystem(); goto d32ff; fefe0: if (is_file($lockFile)) { goto Bb0a9; } goto bde7a; d32ff: $filesystem->mkdir(dirname($lockFile)); goto fefe0; d7060: e8795: goto cf118; B6387: goto e8795; goto D3dc5; cae56: D0e3c: goto Bae03; D3dc5: Bb0a9: goto a40ab; bbd12: if (!(null === $this->lockFile)) { goto D0e3c; } goto Eed2c; Ed20e: $lockFile = sprintf("\x25\163\57\x6d\147\164\x5f\166\141\x72\156\x69\x73\x68\137\x63\141\143\150\145\x5f\x63\162\141\167\x6c\145\x72\56\x6c\157\x63\153", $lockFileDirectory); goto D3cfc; Caaac: } protected function lock() { goto c2a9a; Ca854: $lockFile = $this->getLockFile(); goto dab9a; dab9a: flock($lockFile, LOCK_EX | LOCK_NB); goto Daca1; Daca1: return $this; goto Ff795; c2a9a: $this->isLocked = true; goto Ca854; Ff795: } protected function unlock() { goto a3e1c; dff8b: $lockFile = $this->getLockFile(); goto C7f51; C7f51: flock($lockFile, LOCK_UN); goto d40c8; d40c8: return $this; goto A7bc8; a3e1c: $this->isLocked = false; goto dff8b; A7bc8: } protected function isLocked() { goto e982b; c3291: flock($fp, LOCK_UN); goto Baf13; Fa140: goto C1572; goto Bda4f; b38dc: F8b4e: goto cad67; Bda4f: B0cac: goto D7447; D7447: return $this->isLocked; goto Cc0f7; e982b: if ($this->isLocked !== null) { goto B0cac; } goto E0275; Cc0f7: C1572: goto f3656; E0275: $fp = $this->getLockFile(); goto A2f4e; Baf13: return false; goto b38dc; A2f4e: if (!flock($fp, LOCK_EX | LOCK_NB)) { goto F8b4e; } goto c3291; cad67: return true; goto Fa140; f3656: } protected function runCommand($command, $timeout = 30) { goto a25a4; bd0a9: if (!(false === $process->isSuccessful())) { goto Fe582; } goto E4ff9; Da6c7: $process->run(); goto bd0a9; E4ff9: throw new \RuntimeException($process->getErrorOutput()); goto Daa85; a25a4: $process = new Process($command); goto Dfc60; Daa85: Fe582: goto B443b; B443b: $output = trim($process->getOutput()); goto a3c71; a3c71: return $output; goto B81b1; Dfc60: $process->setTimeout($timeout); goto Da6c7; B81b1: } public function __destruct() { $this->unlock(); } }
